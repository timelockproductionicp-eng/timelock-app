<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Timelock Vault</title>
  <style>
    /* Reset and base styles */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Arial', sans-serif;
      background-color: #05080e;
      background-image:
        linear-gradient(0deg, rgba(255,255,255,0.07) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.07) 1px, transparent 1px);
      background-size: 40px 40px;
      color: #f5f5f5;
      overflow-x: hidden;
    }
    h1,h2,h3 {
      text-align: center;
      margin-bottom: 1rem;
      font-weight: 700;
      text-transform: uppercase;
    }
    .gradient-text {
      background: linear-gradient(90deg,#00b7ff,#c35bff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .container {
      width: 90%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 0;
    }
    /* Buttons */
    .btn {
      display: block;
      width: 100%;
      text-align: center;
      padding: 0.8rem 1rem;
      border-radius: 6px;
      margin-top: 1rem;
      cursor: pointer;
      font-weight: bold;
      font-size: 1rem;
      border: none;
    }
    .btn-primary {
      background: linear-gradient(90deg,#9b5cff,#37c7ff);
      color: #fff;
    }
    .btn-secondary {
      background-color: transparent;
      border: 2px solid #9b5cff;
      color: #9b5cff;
    }
    .btn-danger {
      background-color: transparent;
      border: 2px solid #ff4444;
      color: #ff4444;
    }
    /* Card styles */
    .card-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1.5rem;
    }
    .card {
      background: rgba(15,22,42,0.8);
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 1.5rem;
      width: 280px;
      text-align: center;
      position: relative;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }
    .card .icon-circle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
      font-size: 1.8rem;
      color: #fff;
    }
    /* Colors for icons */
    .icon-purple { background: linear-gradient(90deg,#9345ff,#6922aa); }
    .icon-cyan { background: linear-gradient(90deg,#00c1ff,#00ffc6); }
    .icon-orange { background: linear-gradient(90deg,#ff9b00,#ff4d4d); }
    .card-title { font-size: 1.2rem; font-weight: 700; margin-bottom:0.5rem; text-transform: uppercase; }
    .card-desc { font-size: 0.8rem; color: #aaa; margin-bottom: 1rem; }
    .card.disabled { opacity: 0.4; pointer-events:none; }
    /* Section hidden */
    .section { display: none; }
    .section.active { display: block; }
    /* Form inputs */
    input, textarea, select {
      width: 100%;
      padding: 0.6rem;
      border: 2px solid #444;
      background-color: rgba(20,27,46,0.9);
      color: #fff;
      border-radius: 8px;
      margin-top: 0.5rem;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    textarea { min-height: 100px; }
    select { background-color: rgba(20,27,46,0.9); }
    label { font-size: 0.85rem; color: #87a6c9; display:block; margin-top: 0.5rem;}
    /* Modal overlay */
    .modal-overlay {
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.8);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:100;
    }
    .modal-overlay.active { display:flex; }
    .modal {
      background: rgba(15,22,42,0.95);
      border: 2px solid #4f5bd7;
      border-radius: 12px;
      padding: 1.5rem;
      width: 90%;
      max-width: 500px;
      color:#fff;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      position:relative;
    }
    .modal h3 { margin-top:0; margin-bottom:1rem; text-align:center; }
    .close-btn {
      position:absolute;
      top:0.5rem;
      right:0.5rem;
      cursor:pointer;
      font-size:1.2rem;
      color:#ccc;
    }
    /* Vault contents grid */
    .vault-contents {
      margin-top:2rem;
    }
    .vault-items {
      display:flex;
      flex-wrap: wrap;
      gap:1rem;
      justify-content:flex-start;
    }
    .vault-item {
      flex:1 1 250px;
      border:1px solid #4a4a6a;
      background: rgba(20,27,46,0.9);
      border-radius:10px;
      padding:1rem;
      position:relative;
      display:flex;
      flex-direction:column;
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
      transition: transform 0.2s;
    }
    .vault-item:hover {
      transform: translateY(-4px);
    }
    .vault-item.locked {
      opacity:0.6;
    }
    .vault-item .timer {
      font-size:0.8rem;
      color:#ffcc00;
    }
    .vault-item button {
      margin-top:auto;
    }
    .vault-item .vault-icon {
      font-size:2rem;
      margin-bottom:0.5rem;
    }
    .small { font-size:0.75rem; color:#777; }
    /* Link style */
    .link { color:#37c7ff; cursor:pointer; text-decoration:underline; }
    .system-status {
      display:inline-flex;
      align-items:center;
      background:rgba(56,150,216,0.1);
      padding:0.3rem 0.6rem;
      border-radius:20px;
      font-size:0.75rem;
      color:#00ffbb;
      margin-bottom:1rem;
    }
  </style>
</head>
<body>
  <!-- Home page -->
  <section id="homePage" class="section active">
    <div class="container">
      <h1 class="gradient-text" style="font-size:2.5rem;">TimeLock Vault</h1>
      <p style="text-align:center; margin-bottom:1rem;">Secure your digital assets with quantum‚Äëresistant encryption</p>
      <p style="text-align:center; margin-bottom:2rem; font-size:0.8rem;">Client‚Äëside encryption ¬∑ Time‚Äëlocked security ¬∑ Zero‚Äëknowledge architecture</p>
      <div style="display:flex; justify-content:center; gap:1rem; flex-wrap:wrap;">
        <button class="btn btn-primary" style="max-width:200px;" onclick="showSection('signupPage')">Get Started</button>
        <button class="btn btn-secondary" style="max-width:200px;" onclick="showSection('signinPage')">Already have account</button>
      </div>
      <div class="card-grid" style="margin-top:3rem;">
        <div class="card">
          <div class="icon-circle icon-purple">üîí</div>
          <div class="card-title">AES‚ÄëGCM Encryption</div>
          <div class="card-desc">Military‚Äëgrade encryption happens entirely in your browser</div>
        </div>
        <div class="card">
          <div class="icon-circle icon-cyan">‚è∞</div>
          <div class="card-title">Time‚ÄëLocked Access</div>
          <div class="card-desc">Data remains encrypted until your specified unlock time</div>
        </div>
        <div class="card">
          <div class="icon-circle icon-orange">‚ö°Ô∏è</div>
          <div class="card-title">Zero Knowledge</div>
          <div class="card-desc">Server never sees your passwords or plaintext data</div>
        </div>
      </div>
      <div style="margin-top:2rem; text-align:center; font-size:0.75rem;">
        <span style="color:#ffa800;">‚ö° Quantum‚Äëresistant security protocols ‚ö°</span>
      </div>
    </div>
  </section>
  <!-- Sign Up page -->
  <section id="signupPage" class="section">
    <div class="container" style="max-width:500px;">
      <div class="link" onclick="showSection('homePage')" style="margin-bottom:1rem;">‚Üê Back to Home</div>
      <h2 class="gradient-text">Create Account</h2>
      <p style="text-align:center; font-size:0.7rem; margin-bottom:1rem;">Secure ¬∑ Encrypted ¬∑ Time‚Äëlocked</p>
      <button class="btn btn-secondary" onclick="alert('Google signup not available yet');">Sign up with Google</button>
      <button class="btn btn-secondary" onclick="alert('Yubikey signup not available yet');">Yubikey Authentication</button>
      <button class="btn btn-secondary" onclick="alert('Internet Identity signup not available yet');">Internet Identity</button>
      <label for="signupUsername">Username</label>
      <input id="signupUsername" type="text" placeholder="Choose a username" />
      <label for="signupPassword">Create Password</label>
      <input id="signupPassword" type="password" placeholder="Create a strong password" />
      <button class="btn btn-primary" onclick="createAccount()">Create Account</button>
      <p style="margin-top:1rem; font-size:0.8rem; text-align:center;">Already have an account? <span class="link" onclick="showSection('signinPage')">Sign in here</span></p>
    </div>
  </section>
  <!-- Sign In page -->
  <section id="signinPage" class="section">
    <div class="container" style="max-width:500px;">
      <div class="link" onclick="showSection('homePage')" style="margin-bottom:1rem;">‚Üê Back to Home</div>
      <h2 class="gradient-text">Sign In</h2>
      <p style="text-align:center; font-size:0.7rem; margin-bottom:1rem;">Secure ¬∑ Encrypted ¬∑ Time‚Äëlocked</p>
      <button class="btn btn-secondary" onclick="alert('Google authentication not available yet');">Authenticate with Google</button>
      <button class="btn btn-secondary" onclick="alert('Yubikey authentication not available yet');">Yubikey Authentication</button>
      <button class="btn btn-secondary" onclick="alert('Internet Identity authentication not available yet');">Internet Identity</button>
      <label for="signinUsername">Username</label>
      <input id="signinUsername" type="text" placeholder="Your username" />
      <label for="signinPassword">Password Authentication</label>
      <input id="signinPassword" type="password" placeholder="Enter secure password" />
      <button class="btn btn-primary" onclick="signIn()">Initiate Access</button>
      <p style="margin-top:1rem; font-size:0.8rem; text-align:center;">Don't have an account? <span class="link" onclick="showSection('signupPage')">Create account</span></p>
    </div>
  </section>
  <!-- Vault operations page -->
  <section id="vaultPage" class="section">
    <div class="container">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 class="gradient-text">Vault Operations</h2>
        <div class="link" onclick="logout()">Logout</div>
      </div>
      <p style="text-align:center; margin-bottom:1rem;">Select security protocol</p>
      <div class="system-status"><span style="margin-right:0.5rem; display:inline-block; width:8px; height:8px; background:#00ffbb; border-radius:50%;"></span>System Online</div>
      <div class="card-grid">
        <div class="card" onclick="openEncryptModal('seed')">
          <div class="icon-circle icon-purple">Ôºã</div>
          <div class="card-title">Add Encrypted Seed Phrase</div>
          <div class="card-desc">Secure mnemonic phrases with time‚Äëlocked encryption</div>
          <div class="small">AES‚ÄëGCM Encryption</div>
        </div>
        <div class="card" onclick="openEncryptModal('file')">
          <div class="icon-circle icon-cyan">üóÇÔ∏è</div>
          <div class="card-title">Add Encrypted File Vault</div>
          <div class="card-desc">Store sensitive documents with temporal access control</div>
          <div class="small">AES‚ÄëGCM Encryption</div>
        </div>
        <div class="card disabled">
          <div class="icon-circle icon-orange">üîó</div>
          <div class="card-title">Lock Crypto Assets</div>
          <div class="card-desc">Time‚Äëlocked cryptocurrency storage and recovery</div>
          <div class="small">Blockchain Ready</div>
        </div>
      </div>
      <div style="margin-top:2rem; border:2px solid #4f5bd7; border-radius:10px; padding:1rem;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div style="display:flex; align-items:center;">
            <span style="font-size:1.2rem; margin-right:0.5rem;">üîì</span><span class="gradient-text" style="font-size:1rem;">Unlock Existing Vault</span>
          </div>
          <span class="link" onclick="openDecryptModal()">Initiate Unlock Sequence</span>
        </div>
      </div>
      <!-- Vault contents grid -->
      <div class="vault-contents">
        <h3 class="gradient-text" style="text-align:left;">Vault Contents</h3>
        <div id="vaultItems" class="vault-items">
          <!-- Items will be injected here -->
        </div>
      </div>
      <p id="authMessage" style="margin-top:1rem; font-size:0.8rem; color:#00ffbb;">User authenticated</p>
    </div>
  </section>
  <!-- Encrypt modal overlay -->
  <div id="encryptOverlay" class="modal-overlay">
    <div class="modal">
      <div class="close-btn" onclick="closeEncryptModal()">‚úñ</div>
      <h3 class="gradient-text" id="encryptTitle">Encrypt Data</h3>
      <div id="fileInputContainer">
        <label>Upload File (optional)</label>
        <input type="file" id="fileInput" />
      </div>
      <label for="messageInput">Seed Phrase or Message</label>
      <textarea id="messageInput" placeholder="Enter your seed phrase or secret message..."></textarea>
      <label for="encryptPassword">Encryption Password</label>
      <input type="password" id="encryptPassword" placeholder="Strong password for encryption" />
      <label for="durationInput">Lock Duration</label>
      <input type="number" id="durationInput" value="30" min="1" />
      <select id="durationUnit">
        <option value="minutes">Minutes</option>
        <option value="hours">Hours</option>
        <option value="days">Days</option>
      </select>
      <div style="background:rgba(255,255,0,0.1); padding:0.5rem; border-radius:6px; font-size:0.75rem; color:#ddbb33; margin-top:1rem;">
        <p>Encryption occurs entirely in your browser</p>
        <p>Server never receives your plaintext data or password</p>
        <p>Random IV generated for each encryption operation</p>
        <p>Vault can only be unlocked after the specified time expires</p>
      </div>
      <div style="display:flex; gap:1rem; margin-top:1.5rem;">
        <button class="btn btn-secondary" onclick="closeEncryptModal()">Cancel</button>
        <button class="btn btn-primary" onclick="encryptAndStore()">Encrypt &amp; Lock</button>
      </div>
    </div>
  </div>
  <!-- Success modal -->
  <div id="successOverlay" class="modal-overlay">
    <div class="modal">
      <h3 class="gradient-text">Vault Created</h3>
      <p>Your vault ID is:</p>
      <p id="vaultIdDisplay" style="word-break:break-all; font-size:0.85rem; color:#00ffbb; margin-bottom:1rem;"></p>
      <p id="expiryDisplay"></p>
      <p id="timeRemainingDisplay" style="color:#ffcc00;"></p>
      <div style="display:flex; gap:1rem; margin-top:1.5rem;">
        <button class="btn btn-secondary" onclick="copyVaultId()">Copy ID</button>
        <button class="btn btn-primary" onclick="returnToVault()">Return to Vault</button>
      </div>
    </div>
  </div>
  <!-- Decrypt modal -->
  <div id="decryptOverlay" class="modal-overlay">
    <div class="modal">
      <div class="close-btn" onclick="closeDecryptModal()">‚úñ</div>
      <h3 class="gradient-text">Unlock Vault</h3>
      <label for="vaultIdInput">Vault Identifier</label>
      <input id="vaultIdInput" type="text" placeholder="vault_xxx..." />
      <label for="decryptPassword">Decryption Password</label>
      <input id="decryptPassword" type="password" placeholder="Enter your encryption password" />
      <div style="display:flex; gap:1rem; margin-top:1.5rem;">
        <button class="btn btn-secondary" onclick="closeDecryptModal()">Cancel</button>
        <button class="btn btn-primary" onclick="decryptData()">Decrypt Data</button>
      </div>
      <div id="decryptResult" style="margin-top:1rem; font-size:0.85rem;"></div>
    </div>
  </div>
  <script>
    // Storage keys: accounts and vaults
    function showSection(sectionId) {
      const sections = document.querySelectorAll('.section');
      sections.forEach(sec => sec.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
    }
    // Create account
    function createAccount() {
      const username = document.getElementById('signupUsername').value.trim();
      const password = document.getElementById('signupPassword').value;
      if (!username || !password) {
        alert('Please enter a username and password.');
        return;
      }
      const accounts = JSON.parse(localStorage.getItem('accounts') || '{}');
      if (accounts[username]) {
      alert('Username already exists.');
      return;
      }
      accounts[username] = { password };
      localStorage.setItem('accounts', JSON.stringify(accounts));
      alert('Account created! You can now sign in.');
      showSection('signinPage');
    }
    function signIn() {
      const username = document.getElementById('signinUsername').value.trim();
      const password = document.getElementById('signinPassword').value;
      const accounts = JSON.parse(localStorage.getItem('accounts') || '{}');
      if (!accounts[username] || accounts[username].password !== password) {
        alert('Invalid username or password.');
        return;
      }
      sessionStorage.setItem('currentUser', username);
      document.getElementById('authMessage').innerText = 'User authenticated as ' + username;
      renderVaultContents();
      showSection('vaultPage');
    }
    function logout() {
      sessionStorage.removeItem('currentUser');
      showSection('homePage');
    }
    // Modal controls
    function openEncryptModal(type) {
      document.getElementById('encryptOverlay').classList.add('active');
      document.getElementById('encryptTitle').innerText = type === 'seed' ? 'Encrypt Seed Phrase' : 'Encrypt File Vault';
      document.getElementById('fileInputContainer').style.display = type === 'file' ? 'block' : 'none';
    }
    function closeEncryptModal() {
      document.getElementById('encryptOverlay').classList.remove('active');
      // clear fields
      document.getElementById('fileInput').value = '';
      document.getElementById('messageInput').value = '';
      document.getElementById('encryptPassword').value = '';
      document.getElementById('durationInput').value = '30';
      document.getElementById('durationUnit').value = 'minutes';
    }
    function openDecryptModal() {
      document.getElementById('decryptOverlay').classList.add('active');
      document.getElementById('vaultIdInput').value = '';
      document.getElementById('decryptPassword').value = '';
      document.getElementById('decryptResult').innerHTML = '';
    }
    function closeDecryptModal() {
      document.getElementById('decryptOverlay').classList.remove('active');
    }
    // Encryption utility functions using Web Crypto
    async function deriveKey(password, salt) {
      const enc = new TextEncoder();
      const keyMaterial = await window.crypto.subtle.importKey(
        'raw', enc.encode(password), { name: 'PBKDF2' }, false, ['deriveKey']
      );
      return await window.crypto.subtle.deriveKey(
        { name:'PBKDF2', salt:salt, iterations:100000, hash:'SHA-256' },
        keyMaterial,
        { name:'AES-GCM', length:256 },
        false,
        ['encrypt','decrypt']
      );
    }
    async function encryptAndStore() {
      const message = document.getElementById('messageInput').value;
      const file = document.getElementById('fileInput').files[0];
      const password = document.getElementById('encryptPassword').value;
      const duration = parseInt(document.getElementById('durationInput').value);
      const unit = document.getElementById('durationUnit').value;
      if ((!message && !file) || !password || isNaN(duration)) {
        alert('Please provide message or file, a password and duration.');
        return;
      }
      let dataBuffer;
      let fileName = null;
      if (file) {
        dataBuffer = await file.arrayBuffer();
        fileName = file.name;
      } else {
        dataBuffer = new TextEncoder().encode(message);
      }
      const salt = window.crypto.getRandomValues(new Uint8Array(16));
      const iv = window.crypto.getRandomValues(new Uint8Array(12));
      const key = await deriveKey(password, salt);
      const cipherBuffer = await window.crypto.subtle.encrypt(
        { name:'AES-GCM', iv: iv }, key, dataBuffer
      );
      const expiry = Date.now() + duration * (unit === 'minutes'?60000 : unit === 'hours'?3600000 : 86400000);
      // generate ID
      const id = 'vault_' + Array.from(window.crypto.getRandomValues(new Uint8Array(8))).map(b=>b.toString(16).padStart(2,'0')).join('');
      const vaults = JSON.parse(localStorage.getItem('vaults') || '{}');
      vaults[id] = {
        cipher: Array.from(new Uint8Array(cipherBuffer)).map(b=>b.toString(16).padStart(2,'0')).join(''),
        iv: Array.from(iv).map(b=>b.toString(16).padStart(2,'0')).join(''),
        salt: Array.from(salt).map(b=>b.toString(16).padStart(2,'0')).join(''),
        expiry: expiry,
        fileName: fileName,
        isFile: !!file
      };
      localStorage.setItem('vaults', JSON.stringify(vaults));
      closeEncryptModal();
      showSuccess(id, expiry);
      renderVaultContents();
    }
    function showSuccess(id, expiry) {
      document.getElementById('vaultIdDisplay').innerText = id;
      const expiryDate = new Date(expiry);
      document.getElementById('expiryDisplay').innerText = 'Unlocks at: ' + expiryDate.toLocaleString();
      function updateRemaining() {
        const now = Date.now();
        const remaining = expiry - now;
        if (remaining <= 0) {
          document.getElementById('timeRemainingDisplay').innerText = 'Unlocked!';
          clearInterval(timerInterval);
        } else {
          const mins = Math.floor((remaining/60000)%60);
          const hrs = Math.floor((remaining/3600000)%24);
          const days = Math.floor(remaining/86400000);
          document.getElementById('timeRemainingDisplay').innerText = 'Time remaining: ' + (days>0?days+'d ':'') + (hrs>0?hrs+'h ':'') + mins + 'm';
        }
      }
      updateRemaining();
      const timerInterval = setInterval(updateRemaining, 60000);
      document.getElementById('successOverlay').classList.add('active');
    }
    function copyVaultId() {
      const id = document.getElementById('vaultIdDisplay').innerText;
      navigator.clipboard.writeText(id).then(()=>{ alert('Vault ID copied!'); });
    }
    function returnToVault() {
      document.getElementById('successOverlay').classList.remove('active');
      showSection('vaultPage');
    }
    async function decryptData() {
      const id = document.getElementById('vaultIdInput').value.trim();
      const password = document.getElementById('decryptPassword').value;
      const vaults = JSON.parse(localStorage.getItem('vaults') || '{}');
      if (!vaults[id]) {
        alert('Vault not found.');
        return;
      }
      const entry = vaults[id];
      if (Date.now() < entry.expiry) {
        alert('Vault is still locked.');
        return;
      }
      // decode hex string to bytes
      function hexToBytes(hex) {
        const bytes = new Uint8Array(hex.length/2);
        for (let i=0;i<bytes.length;i++) {
          bytes[i] = parseInt(hex.substr(i*2,2),16);
        }
        return bytes;
      }
      const iv = hexToBytes(entry.iv);
      const salt = hexToBytes(entry.salt);
      const cipherBytes = hexToBytes(entry.cipher);
      const key = await deriveKey(password, salt);
      try {
        const plainBuffer = await window.crypto.subtle.decrypt(
          { name:'AES-GCM', iv: iv }, key, cipherBytes
        );
        let result;
        if (entry.isFile) {
          const blob = new Blob([plainBuffer]);
          const url = URL.createObjectURL(blob);
          result = '<a href="' + url + '" download="'+ (entry.fileName || 'download') +'">Download file</a>';
        } else {
          const decoder = new TextDecoder();
          result = decoder.decode(plainBuffer);
        }
        document.getElementById('decryptResult').innerHTML = '<div style="margin-top:0.5rem;">' + result + '</div>';
        renderVaultContents();
      } catch (e) {
        alert('Incorrect password or corrupted data.');
      }
    }
    function renderVaultContents() {
      const vaults = JSON.parse(localStorage.getItem('vaults') || '{}');
      const container = document.getElementById('vaultItems');
      container.innerHTML = '';
      const entries = Object.entries(vaults);
      if (entries.length === 0) {
        container.innerHTML = '<p style="color:#777;">No vaults stored.</p>';
        return;
      }
      entries.forEach(([id, entry]) => {
        const now = Date.now();
        const locked = now < entry.expiry;
        const item = document.createElement('div');
        item.className = 'vault-item' + (locked ? ' locked' : '');
        // icon indicating type
        const iconEl = document.createElement('div');
        iconEl.className = 'vault-icon';
        iconEl.textContent = entry.isFile ? 'üìÅ' : 'üìù';
        const title = document.createElement('div');
        title.style.fontWeight = 'bold';
        title.style.marginBottom = '0.5rem';
        title.textContent = entry.isFile ? (entry.fileName || 'Encrypted File') : 'Encrypted Message';
        const idEl = document.createElement('div');
        idEl.style.fontSize = '0.7rem';
        idEl.style.wordBreak = 'break-all';
        idEl.textContent = id;
        const timerEl = document.createElement('div');
        timerEl.className = 'timer';
        function updateTimer() {
          const remain = entry.expiry - Date.now();
          if (remain <= 0) {
            timerEl.textContent = 'Unlocked!';
          } else {
            const mins = Math.floor((remain/60000)%60);
            const hrs = Math.floor((remain/3600000)%24);
            const days = Math.floor(remain/86400000);
            timerEl.textContent = 'Unlocks in ' + (days>0?days+'d ':'') + (hrs>0?hrs+'h ':'') + mins + 'm';
          }
        }
        updateTimer();
        if (locked) {
          setInterval(updateTimer, 60000);
        }
        const button = document.createElement('button');
        button.className = 'btn btn-primary';
        button.textContent = locked ? 'Copy ID' : (entry.isFile ? 'Download' : 'View');
        button.onclick = () => {
          if (locked) {
            navigator.clipboard.writeText(id).then(() => { alert('ID copied to clipboard'); });
          } else {
            const pass = prompt('Enter your password to unlock');
            if (!pass) return;
            decryptSpecific(id, pass, entry, item);
          }
        };
        item.appendChild(iconEl);
        item.appendChild(title);
        item.appendChild(idEl);
        item.appendChild(timerEl);
        item.appendChild(button);
        container.appendChild(item);
      });
    }
    async function decryptSpecific(id, password, entry, itemDiv) {
      function hexToBytes(hex) {
        const bytes = new Uint8Array(hex.length/2);
        for (let i=0;i<bytes.length;i++) {
          bytes[i] = parseInt(hex.substr(i*2,2),16);
        }
        return bytes;
      }
      const iv = hexToBytes(entry.iv);
      const salt = hexToBytes(entry.salt);
      const cipherBytes = hexToBytes(entry.cipher);
      const key = await deriveKey(password, salt);
      try {
        const plainBuffer = await window.crypto.subtle.decrypt(
          { name:'AES-GCM', iv: iv }, key, cipherBytes
        );
        if (entry.isFile) {
          const blob = new Blob([plainBuffer]);
          const url = URL.createObjectURL(blob);
          window.open(url, '_blank');
        } else {
          const decoder = new TextDecoder();
          const text = decoder.decode(plainBuffer);
          alert('Decrypted message: ' + text);
        }
      } catch {
        alert('Incorrect password.');
      }
    }
    // When page loads, if user session exists, show vault page
    window.addEventListener('load', () => {
      if (sessionStorage.getItem('currentUser')) {
        showSection('vaultPage');
        document.getElementById('authMessage').innerText = 'User authenticated as ' + sessionStorage.getItem('currentUser');
        renderVaultContents();
      }
    });
  </script>
</body>
</html>
