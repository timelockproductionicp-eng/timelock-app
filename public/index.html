<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Timelock Vault</title>
  <style>
    /* Base styles and dark grid background */
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      color: #f3f3f3;
      /* black background with subtle grid */
      background-color: #010409;
      background-image: linear-gradient(#0a0f17 1px, transparent 1px), linear-gradient(90deg, #0a0f17 1px, transparent 1px);
      background-size: 32px 32px;
      overflow-y: auto;
    }
    h1, h2, h3 {
      margin-top: 0;
      margin-bottom: 0.5rem;
      font-weight: 700;
      text-align: center;
      /* neon gradient for headings */
      background: linear-gradient(90deg, #a855f7, #0ea5e9, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    a {
      color: #38bdf8;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .page {
      display: none;
      padding: 2rem 1rem;
      max-width: 900px;
      margin: 0 auto;
    }
    .active {
      display: block;
    }
    /* Hero section styles */
    .hero {
      padding: 5rem 1rem;
      text-align: center;
    }
    .features {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1.5rem;
      margin: 2rem 0;
    }
    .feature-card {
      background: rgba(12, 18, 28, 0.8);
      border: 1px solid #1f2937;
      border-radius: 0.5rem;
      padding: 1.5rem;
      width: 250px;
      box-shadow: 0 0 10px rgba(168, 85, 247, 0.3);
      text-align: center;
    }
    .feature-card h3 {
      margin-bottom: 0.5rem;
      font-size: 1.25rem;
    }
    .buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 2rem;
    }
    button.primary {
      background: linear-gradient(90deg, #a855f7, #0ea5e9);
      border: none;
      color: #fff;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.15s;
    }
    button.primary:hover {
      transform: translateY(-2px);
    }
    button.secondary {
      background: transparent;
      border: 1px solid #38bdf8;
      color: #38bdf8;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.15s;
    }
    button.secondary:hover {
      transform: translateY(-2px);
    }
    /* Auth pages */
    .auth-options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    .auth-options button {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      border: none;
      font-size: 1rem;
      cursor: pointer;
    }
    .auth-options button.google {
      background: #ea4335;
      color: #fff;
    }
    .auth-options button.yubi {
      background: #f59e0b;
      color: #fff;
    }
    .auth-options button.ii {
      background: #059669;
      color: #fff;
    }
    .form-control {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border-radius: 0.4rem;
      border: 1px solid #334155;
      background: #0f172a;
      color: #f3f3f3;
    }
    .form-control::placeholder {
      color: #64748b;
    }
    .auth-action {
      width: 100%;
      padding: 0.5rem;
      border-radius: 0.4rem;
      background: linear-gradient(90deg, #a855f7, #0ea5e9);
      border: none;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
    }
    /* Vault page cards */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
      margin: 2rem 0;
    }
    .card {
      background: rgba(12, 18, 28, 0.8);
      border: 1px solid #1f2937;
      border-radius: 0.5rem;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: transform 0.15s;
    }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 0 10px rgba(14, 165, 233, 0.3);
    }
    .card.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    /* Vault contents grid */
    .vault-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    .vault-item {
      background: rgba(12, 18, 28, 0.8);
      border: 1px solid #1f2937;
      border-radius: 0.5rem;
      padding: 0.75rem;
      position: relative;
    }
    .vault-item .name {
      font-weight: bold;
      margin-bottom: 0.25rem;
    }
    .vault-item .status {
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }
    .vault-item button {
      padding: 0.3rem 0.6rem;
      border: none;
      border-radius: 0.3rem;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .vault-item button.view {
      background: #0ea5e9;
      color: #fff;
    }
    .vault-item button.locked {
      background: #334155;
      color: #94a3b8;
      cursor: not-allowed;
    }
    /* Modals */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: #0f172a;
      padding: 1.5rem;
      border-radius: 0.5rem;
      max-width: 500px;
      width: 90%;
      border: 1px solid #1f2937;
      box-shadow: 0 0 20px rgba(14, 165, 233, 0.2);
    }
    .modal-content h3 {
      margin-top: 0;
      text-align: center;
    }
    .modal-content input, .modal-content textarea, .modal-content select {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 0.8rem;
      border-radius: 0.4rem;
      border: 1px solid #334155;
      background: #0a1420;
      color: #f3f3f3;
    }
    .modal-content button {
      width: 100%;
      padding: 0.6rem;
      margin-top: 0.5rem;
      border-radius: 0.4rem;
      border: none;
      font-size: 1rem;
      cursor: pointer;
    }
    .encrypt-btn {
      background: linear-gradient(90deg, #a855f7, #0ea5e9);
      color: #fff;
    }
    .cancel-btn {
      background: #334155;
      color: #94a3b8;
    }
    .success-btn {
      background: #10b981;
      color: #fff;
    }
    @media (max-width: 500px) {
      .features {
        flex-direction: column;
      }
      .cards {
        grid-template-columns: 1fr;
      }
      .vault-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Home page -->
  <div id="homePage" class="page active">
    <div class="hero">
      <h1>Timelock Vault</h1>
      <p>Secure your digital assets with quantum‑resistant encryption</p>
      <p style="font-size:0.9rem; opacity:0.8;">Client‑side encryption • Time‑locked security • Zero‑knowledge architecture</p>
      <div class="features">
        <div class="feature-card">
          <h3>AES‑GCM Encryption</h3>
          <p>Military‑grade encryption happens entirely in your browser.</p>
        </div>
        <div class="feature-card">
          <h3>Time‑Locked Access</h3>
          <p>Data remains encrypted until your specified unlock time.</p>
        </div>
        <div class="feature-card">
          <h3>Zero‑Knowledge</h3>
          <p>Server never sees your passwords or plaintext data.</p>
        </div>
      </div>
      <div class="buttons">
        <button class="primary" onclick="showPage('signupPage')">Get Started</button>
        <button class="secondary" onclick="showPage('signinPage')">Already have account</button>
      </div>
    </div>
    <div style="max-width:700px; margin:2rem auto; border:1px solid #334155; padding:1rem; border-radius:0.5rem; background:#0a1420;">
      <h3>Security Guarantee</h3>
      <p>Your data is encrypted with AES‑GCM using PBKDF2 key derivation (100,000 iterations) entirely within your browser. The server only stores encrypted data and never has access to your passwords or plaintext content. Time‑locked vaults cannot be unlocked before the specified time, even with correct credentials.</p>
    </div>
  </div>
  <!-- Sign up page -->
  <div id="signupPage" class="page">
    <h2>Create Account</h2>
    <div class="auth-options">
      <button class="google" id="googleSignup">Sign up with Google</button>
      <button class="yubi" id="yubiSignup">Sign up with Yubikey</button>
      <button class="ii" id="iiSignup">Sign up with Internet Identity</button>
    </div>
    <div style="text-align:center; margin:0.5rem 0; opacity:0.6;">— OR —</div>
    <input type="text" id="signupUsername" class="form-control" placeholder="Username">
    <input type="password" id="signupPassword" class="form-control" placeholder="Encryption password">
    <button id="createAccount" class="auth-action">Create Account</button>
    <p style="text-align:center; margin-top:1rem;">Already have an account? <a href="#" onclick="showPage('signinPage')">Sign in here</a></p>
  </div>
  <!-- Sign in page -->
  <div id="signinPage" class="page">
    <h2>Sign In</h2>
    <div class="auth-options">
      <button class="google" id="googleSignin">Sign in with Google</button>
      <button class="yubi" id="yubiSignin">Sign in with Yubikey</button>
      <button class="ii" id="iiSignin">Sign in with Internet Identity</button>
    </div>
    <div style="text-align:center; margin:0.5rem 0; opacity:0.6;">— OR —</div>
    <input type="text" id="signinUsername" class="form-control" placeholder="Username">
    <input type="password" id="signinPassword" class="form-control" placeholder="Encryption password">
    <button id="login" class="auth-action">Sign In</button>
    <p style="text-align:center; margin-top:1rem;">Don't have an account? <a href="#" onclick="showPage('signupPage')">Create one</a></p>
  </div>
  <!-- Vault operations page -->
  <div id="vaultPage" class="page">
    <h2>Vault Operations</h2>
    <div class="cards">
      <div class="card" onclick="openEncryptModal('message')">
        <h3>Add encrypted seed phrase</h3>
        <p>Securely lock your seed phrase or secret message.</p>
      </div>
      <div class="card" onclick="openEncryptModal('file')">
        <h3>Add encrypted file vault</h3>
        <p>Upload a file and lock it until you need it.</p>
      </div>
      <div class="card disabled">
        <h3>Lock crypto assets</h3>
        <p>Coming soon</p>
      </div>
      <div class="card" onclick="showDecryptModal()">
        <h3>Unlock existing vault</h3>
        <p>Unlock using vault identifier and password.</p>
      </div>
    </div>
    <button id="logoutBtn" class="secondary" style="margin-bottom:1rem;" onclick="logout()">Log out</button>
    <h3 style="margin-top:2rem;">Vault Contents</h3>
    <div id="vaultContents" class="vault-grid"></div>
  </div>
  <!-- Encryption modal -->
  <div id="encryptModal" class="modal">
    <div class="modal-content">
      <h3 id="encryptTitle">Encrypt Data</h3>
      <input type="file" id="fileInput" style="display:none;">
      <textarea id="messageInput" rows="4" placeholder="Enter seed phrase or message" style="display:none;"></textarea>
      <input type="password" id="encryptPassword" placeholder="Encryption password">
      <div style="display:flex; gap:0.5rem; align-items:center;">
        <label style="flex:1;">Duration
          <input type="number" id="durationInput" value="5" min="1" class="form-control" style="width:100%;">
        </label>
        <label style="flex:1;">Unit
          <select id="durationUnit" class="form-control">
            <option value="minutes">Minutes</option>
            <option value="hours">Hours</option>
            <option value="days">Days</option>
          </select>
        </label>
      </div>
      <button class="encrypt-btn" onclick="encryptAndStore()">Encrypt & Lock</button>
      <button class="cancel-btn" onclick="closeEncryptModal()">Cancel</button>
    </div>
  </div>
  <!-- Success modal -->
  <div id="successModal" class="modal">
    <div class="modal-content">
      <h3>Vault Created</h3>
      <p id="vaultIdDisplay"></p>
      <p id="unlockTimeDisplay"></p>
      <p id="countdownDisplay" style="font-weight:bold;"></p>
      <button class="success-btn" onclick="returnToVault()">Return to Vault</button>
    </div>
  </div>
  <!-- Decrypt modal -->
  <div id="decryptModal" class="modal">
    <div class="modal-content">
      <h3>Unlock Vault</h3>
      <input type="text" id="decryptVaultId" placeholder="Vault identifier" class="form-control">
      <input type="password" id="decryptPassword" placeholder="Encryption password" class="form-control">
      <button class="encrypt-btn" onclick="decryptData()">Decrypt Data</button>
      <button class="cancel-btn" onclick="closeDecryptModal()">Cancel</button>
      <div id="decryptedOutput" style="margin-top:1rem; white-space:pre-wrap;"></div>
    </div>
  </div>
  <script>
    // Utility to switch between pages
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
    }
    // Handle dummy external sign up/sign in options
    function setupAuthButtons() {
      ['googleSignup','yubiSignup','iiSignup','googleSignin','yubiSignin','iiSignin'].forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
          btn.onclick = () => alert('This authentication method is not implemented. Please use username/password.');
        }
      });
    }
    // Create account with username/password and store in localStorage
    function createAccount() {
      const username = document.getElementById('signupUsername').value.trim();
      const password = document.getElementById('signupPassword').value;
      if (!username || !password) {
        alert('Please enter a username and password.');
        return;
      }
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      if (users[username]) {
        alert('Username already exists.');
        return;
      }
      users[username] = { password };
      localStorage.setItem('users', JSON.stringify(users));
      alert('Account created! You can sign in now.');
      showPage('signinPage');
    }
    // Sign in with username/password
    function signIn() {
      const username = document.getElementById('signinUsername').value.trim();
      const password = document.getElementById('signinPassword').value;
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      if (!users[username] || users[username].password !== password) {
        alert('Invalid credentials.');
        return;
      }
      localStorage.setItem('currentUser', username);
      showPage('vaultPage');
      renderVaultContents();
    }
    // Logout current user
    function logout() {
      localStorage.removeItem('currentUser');
      showPage('homePage');
    }
    // Open encryption modal for message or file
    let currentEncryptType = 'message';
    function openEncryptModal(type) {
      currentEncryptType = type;
      document.getElementById('encryptModal').style.display = 'flex';
      if (type === 'file') {
        document.getElementById('fileInput').style.display = 'block';
        document.getElementById('messageInput').style.display = 'none';
        document.getElementById('encryptTitle').innerText = 'Encrypt File';
      } else {
        document.getElementById('fileInput').style.display = 'none';
        document.getElementById('messageInput').style.display = 'block';
        document.getElementById('encryptTitle').innerText = 'Encrypt Seed Phrase / Message';
      }
    }
    function closeEncryptModal() {
      document.getElementById('encryptModal').style.display = 'none';
      document.getElementById('fileInput').value = '';
      document.getElementById('messageInput').value = '';
      document.getElementById('encryptPassword').value = '';
      document.getElementById('durationInput').value = 5;
      document.getElementById('durationUnit').value = 'minutes';
    }
    // Generate a random identifier
    function generateId() {
      return 'vault_' + Math.random().toString(36).substring(2, 10) + Date.now().toString(36);
    }
    // Helper to derive a key from password using PBKDF2
    async function deriveKey(password, salt) {
      const enc = new TextEncoder();
      const keyMaterial = await window.crypto.subtle.importKey(
        'raw', enc.encode(password), { name: 'PBKDF2' }, false, ['deriveKey']
      );
      return window.crypto.subtle.deriveKey(
        {
          name: 'PBKDF2',
          salt: salt,
          iterations: 100000,
          hash: 'SHA-256'
        },
        keyMaterial,
        { name: 'AES-GCM', length: 256 },
        false,
        ['encrypt', 'decrypt']
      );
    }
    // Encrypt and store data
    async function encryptAndStore() {
      const password = document.getElementById('encryptPassword').value;
      const duration = parseInt(document.getElementById('durationInput').value, 10);
      const unit = document.getElementById('durationUnit').value;
      if (!password || !duration) {
        alert('Please enter a password and duration.');
        return;
      }
      let dataBytes;
      let fileName = '';
      if (currentEncryptType === 'file') {
        const file = document.getElementById('fileInput').files[0];
        if (!file) {
          alert('Please select a file to encrypt.');
          return;
        }
        fileName = file.name;
        const arrayBuffer = await file.arrayBuffer();
        dataBytes = new Uint8Array(arrayBuffer);
      } else {
        const message = document.getElementById('messageInput').value;
        if (!message) {
          alert('Please enter a message or seed phrase.');
          return;
        }
        const enc = new TextEncoder();
        dataBytes = enc.encode(message);
      }
      // Determine expiry timestamp
      const now = Date.now();
      let expiresInMs = duration * 60000;
      if (unit === 'hours') expiresInMs = duration * 60 * 60000;
      if (unit === 'days') expiresInMs = duration * 24 * 60 * 60000;
      const expiry = now + expiresInMs;
      // Generate salt and iv
      const salt = window.crypto.getRandomValues(new Uint8Array(16));
      const iv = window.crypto.getRandomValues(new Uint8Array(12));
      const key = await deriveKey(password, salt);
      const cipherBuffer = await window.crypto.subtle.encrypt(
        { name: 'AES-GCM', iv: iv },
        key,
        dataBytes
      );
      // Convert to Base64 for storage
      const cipherArray = new Uint8Array(cipherBuffer);
      const cipherBase64 = btoa(String.fromCharCode(...cipherArray));
      const saltBase64 = btoa(String.fromCharCode(...salt));
      const ivBase64 = btoa(String.fromCharCode(...iv));
      const vaultId = generateId();
      // Determine current user
      const currentUser = localStorage.getItem('currentUser') || 'guest';
      const vaults = JSON.parse(localStorage.getItem('vaults') || '{}');
      vaults[vaultId] = {
        type: currentEncryptType,
        cipher: cipherBase64,
        salt: saltBase64,
        iv: ivBase64,
        expiry: expiry,
        filename: fileName,
        owner: currentUser
      };
      localStorage.setItem('vaults', JSON.stringify(vaults));
      // Show success modal
      closeEncryptModal();
      document.getElementById('vaultIdDisplay').innerText = 'Vault ID: ' + vaultId;
      const unlockDate = new Date(expiry);
      document.getElementById('unlockTimeDisplay').innerText = 'Unlocks at: ' + unlockDate.toLocaleString();
      startCountdown(expiry);
      document.getElementById('successModal').style.display = 'flex';
      // Re-render contents after creation
      renderVaultContents();
    }
    function startCountdown(expiry) {
      function update() {
        const now = Date.now();
        const diff = expiry - now;
        if (diff <= 0) {
          document.getElementById('countdownDisplay').innerText = 'Unlocked now!';
          clearInterval(timer);
          return;
        }
        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((diff % (1000 * 60)) / 1000);
        let parts = [];
        if (d) parts.push(d + 'd');
        if (h) parts.push(h + 'h');
        if (m) parts.push(m + 'm');
        parts.push(s + 's');
        document.getElementById('countdownDisplay').innerText = 'Time remaining: ' + parts.join(' ');
      }
      update();
      const timer = setInterval(update, 1000);
    }
    function returnToVault() {
      document.getElementById('successModal').style.display = 'none';
      showPage('vaultPage');
      renderVaultContents();
    }
    // Render vault contents grid
    function renderVaultContents() {
      const container = document.getElementById('vaultContents');
      container.innerHTML = '';
      const vaults = JSON.parse(localStorage.getItem('vaults') || '{}');
      const now = Date.now();
      Object.entries(vaults).forEach(([id, v]) => {
        // Only show items belonging to current user or guest; ignore others
        const currentUser = localStorage.getItem('currentUser') || 'guest';
        if (v.owner !== currentUser) return;
        const itemDiv = document.createElement('div');
        itemDiv.className = 'vault-item';
        const nameDiv = document.createElement('div');
        nameDiv.className = 'name';
        nameDiv.textContent = v.type === 'file' ? (v.filename || 'Encrypted File') : 'Encrypted Message';
        const statusDiv = document.createElement('div');
        statusDiv.className = 'status';
        const btn = document.createElement('button');
        if (now >= v.expiry) {
          statusDiv.textContent = 'Unlocked';
          btn.textContent = 'View';
          btn.className = 'view';
          btn.onclick = () => {
            // Pre-fill id and show decrypt modal
            document.getElementById('decryptVaultId').value = id;
            document.getElementById('decryptPassword').value = '';
            document.getElementById('decryptedOutput').textContent = '';
            document.getElementById('decryptModal').style.display = 'flex';
          };
        } else {
          const diff = v.expiry - now;
          const m = Math.floor(diff / 60000);
          const s = Math.floor((diff % 60000) / 1000);
          statusDiv.textContent = 'Locked: ' + m + 'm ' + s + 's';
          btn.textContent = 'Locked';
          btn.className = 'locked';
        }
        itemDiv.appendChild(nameDiv);
        itemDiv.appendChild(statusDiv);
        itemDiv.appendChild(btn);
        container.appendChild(itemDiv);
      });
    }
    // Show decrypt modal for manual unlock from operations card
    function showDecryptModal() {
      document.getElementById('decryptVaultId').value = '';
      document.getElementById('decryptPassword').value = '';
      document.getElementById('decryptedOutput').textContent = '';
      document.getElementById('decryptModal').style.display = 'flex';
    }
    function closeDecryptModal() {
      document.getElementById('decryptModal').style.display = 'none';
    }
    // Decrypt data by id and password
    async function decryptData() {
      const id = document.getElementById('decryptVaultId').value.trim();
      const password = document.getElementById('decryptPassword').value;
      const vaults = JSON.parse(localStorage.getItem('vaults') || '{}');
      const item = vaults[id];
      if (!item) {
        alert('Vault not found');
        return;
      }
      if (Date.now() < item.expiry) {
        alert('This vault is still locked!');
        return;
      }
      const salt = Uint8Array.from(atob(item.salt), c => c.charCodeAt(0));
      const iv = Uint8Array.from(atob(item.iv), c => c.charCodeAt(0));
      const key = await deriveKey(password, salt);
      const cipher = Uint8Array.from(atob(item.cipher), c => c.charCodeAt(0));
      try {
        const decryptedBuffer = await window.crypto.subtle.decrypt(
          { name: 'AES-GCM', iv: iv },
          key,
          cipher
        );
        let outputDiv = document.getElementById('decryptedOutput');
        if (item.type === 'file') {
          const blob = new Blob([decryptedBuffer]);
          const url = URL.createObjectURL(blob);
          outputDiv.innerHTML = '';
          const link = document.createElement('a');
          link.href = url;
          link.download = item.filename || 'download';
          link.textContent = 'Download ' + (item.filename || 'file');
          link.style.color = '#38bdf8';
          outputDiv.appendChild(link);
        } else {
          const dec = new TextDecoder();
          const message = dec.decode(decryptedBuffer);
          outputDiv.textContent = message;
        }
      } catch (e) {
        alert('Failed to decrypt. Incorrect password?');
      }
    }
    // Event listeners setup
    document.getElementById('createAccount').addEventListener('click', createAccount);
    document.getElementById('login').addEventListener('click', signIn);
    setupAuthButtons();
  </script>
</body>
</html>
